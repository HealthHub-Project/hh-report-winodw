<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../vaadin-icons/vaadin-icons.html">

<link rel="import" href="../hh-image-report/hh-image-report.html">
<link rel="import" href="../hh-reading-template/hh-reading-template.html">
<link rel="import" href="../hh-clinical-info/hh-clinical-info.html">
<link rel="import" href="../hh-thumbnail/hh-thumbnail.html">
<link rel="import" href="../hh-report/hh-report.html">
<link rel="import" href="../hh-report-oldFilm/hh-report-oldfilm.html">

<dom-module id="hh-report-window">
    <template>
        <style>
            :host {
                display: block;
                width: 470px;
                height: 100%;
                background-color: #2d333e;
            }

            .container {
                display: flex;
                flex: 1 1;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }

            paper-tabs {
                --paper-tabs-selection-bar: {
                    border-bottom: 3px solid #0087cb;
                    color: #2baab1;
                };
                --paper-tabs-content: {
                    font-weight: bold;
                    color: #aaaaaa;
                    font-size: 13px;

                };
                background-color: #252934;
                box-shadow: 0px 3px 9px -2px #000000;
                border-top-left-radius: 3px;
                border-top-right-radius: 3px;
                height: 30px;
            }

            paper-tabs paper-tab.iron-selected {
                color: #2baab1;
            }

            paper-tabs paper-tab[disabled] {
                color: #424242;
            }

            iron-pages {
                width: 100%;
                height: calc(100% - 30px);
                background-color: rgba(0, 0, 0, 0.10);
                border-bottom-left-radius: 3px;
                border-bottom-right-radius: 3px;
            }

            .container-report-setting {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding-left: 10px;
                padding-right: 5px;
                background-color: #252934;
                height: 24px;
                font-weight: bold;
                font-size: 12px;

                box-shadow: 0px 3px 9px -2px #000000;
            }

            .report-setting-title {
                color: grey;
            }

            .report-setting-patientInfo {
                color: #aaa;
            }

            paper-icon-button {
                width: 25px;
                height: 100%;
                padding: 5px;
                color: #aaa;
            }

            paper-icon-button[active] {
                color: #d9534f;
            }

            paper-icon-button:hover {
                color: #0087cb;
            }


        </style>
        <div class="container">
            <div class="container-report-setting">
                <div class="report-setting-title">
                    Report window
                </div>
                <div class="report-setting-patientInfo">
                    {{patientInfo}}
                </div>
                <div>
                    <paper-icon-button id="btnPin" noink toggles icon="vaadin:pin" title="pin" on-click="_pin"></paper-icon-button>
                    <paper-icon-button id="btnExpand" noink toggles icon="vaadin:expand" title="pin" on-click="_expand"></paper-icon-button>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; width: 100%; height: 100%">
                <div style="height: 400px; width: 100%; display: flex; justify-content: space-evenly;">
                    <div id="div1" style="height: 385px; width: 380px; padding-top: 10px">
                        <paper-tabs selected="{{selectedTop}}" noink>
                            <paper-tab>Thumbnail</paper-tab>
                            <paper-tab>Report Image</paper-tab>
                            <paper-tab id="readingTemplateTab">Reading Template</paper-tab>
                            <paper-tab id="clinicalInfoTab">Clinical Info</paper-tab>
                        </paper-tabs>
                        <iron-pages id="reportWindowPage" selected="{{selectedTop}}">
                            <div class="reading-content" style="height: 100%; width: 100%;">
                                <hh-thumbnail id="hhThumbnail"></hh-thumbnail>
                            </div>
                            <div class="reading-content" style="height: 100%; width: 100%;">
                                <hh-image-report id="hhImageReport" style="height: 355px; width: 100%;"></hh-image-report>
                            </div>
                            <div id="readingTemplatePage" style="height: 100%">
                                <hh-reading-template id="hhReadingTemplate"></hh-reading-template>
                            </div>
                            <div id="clinicalInfoPage" style="height: 100%">
                                <hh-clinical-info id="hhClinicalInfo"></hh-clinical-info>
                            </div>
                        </iron-pages>
                    </div>
                    <div id="div2" style="height: 385px; width: 250px; padding-top: 10px; display: flex; flex-direction: column;">
                        <div style="height: 30px; display:flex; align-items: center; padding-left: 10px;background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                            Clinical Info
                        </div>
                        <div style="background-color: rgba(0,0,0,0.15); height: 355px;border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">
                            <hh-clinical-info id="hhClinicalInfoExpend"></hh-clinical-info>
                        </div>
                    </div>
                    <div id="div3" style="height: 385px; width: 330px; padding-top: 10px; display: flex; flex-direction: column;">
                        <div style="height: 30px; display:flex; align-items: center; padding-left: 10px;background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                            Reading Template
                        </div>
                        <div style="background-color: rgba(0,0,0,0.15); height: 355px;border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">
                            <hh-reading-template id="hhReadingTemplateExpand"></hh-reading-template>
                        </div>
                    </div>
                </div>
                <div style="height: calc(100% - 400px); width: 100%; display: flex;justify-content: space-evenly;">
                    <div id="div4" style="height: calc(100% - 15px); width: 380px; padding-top: 5px">
                        <div style="height: 30px; display:flex; align-items: center; margin-bottom: 5px; padding-left: 10px;background-color: #252934;font-weight: bold;font-size: 12px;box-shadow: 0px 3px 9px -2px #000000; color: #aaaaaa; font-size: 13px;">
                            OldFIlm Report LIst
                        </div>
                        <div style="background-color: rgba(0,0,0,0.15); height: calc(100% - 35px); border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">
                            <hh-report-oldFilm id="allHhReportOldFilm"></hh-report-oldFilm>
                        </div>
                    </div>
                    <div id="div5" style="height: calc(100% - 15px); width: 590px; padding-top: 5px">
                        <paper-tabs selected="{{selectedBottomNew}}" noink>
                            <paper-tab>Report</paper-tab>
                            <paper-tab disabled>Structured Reporting</paper-tab>
                            <paper-tab disabled>Dictation</paper-tab>
                            <paper-tab disabled>Transcription</paper-tab>
                        </paper-tabs>
                        <iron-pages selected="{{selectedBottomNew}}">
                            <div style="height: 100%; width: 100%;">
                                <hh-report id="report"></hh-report>
                            </div>
                            <div></div>
                            <div></div>
                            <div></div>
                        </iron-pages>
                    </div>
                </div>
            </div>

        </div>
    </template>

    <script>
        /**
         * `hh-report-window`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        (function () {
                let parentWidth;
                let g_objId;
                let g_message = {
                    msg: "",
                    isErr: false
                };

                let _this;

                class HhReportWindow extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
                    static get is() {
                        return 'hh-report-window';
                    }

                    constructor() {
                        super();
                        _this = this;
                    }

                    ready() {
                        super.ready();

                        this.addEventListener('iron-resize', () => {
                            this._onIronResize()
                        });

                        this.$.report.addEventListener('btnClickEvent', (e) => {
                            _this.dispatchEvent(new CustomEvent('reportBtnClickEvent', e));
                        });

                        if (!this.expand) {
                            this.style.width = '470px';
                            this.parentNode.querySelector('#worklistLeftDiv').style.width = 'calc(100% - 470px)';

                            this.$.div2.style.display = 'none';
                            this.$.div3.style.display = 'none';
                            this.$.div4.style.display = 'none';
                            this.$.div1.style.width = 'calc(100% - 20px)';
                            this.$.div5.style.width = 'calc(100% - 20px)';

                            this.$.readingTemplateTab.style.display = 'block';
                            this.$.readingTemplatePage.style.display = 'block';
                            this.$.clinicalInfoTab.style.display = 'block';
                            this.$.clinicalInfoPage.style.display = 'block';

                        } else {
                            this.style.width = '1000px';
                            this.parentNode.querySelector('#worklistLeftDiv').style.width = 'calc(100% - 1000px)';

                            this.$.div2.style.display = 'block';
                            this.$.div3.style.display = 'block';
                            this.$.div4.style.display = 'block';
                            this.$.div1.style.width = '380px';
                            this.$.div5.style.width = '590px';

                            this.$.readingTemplateTab.style.display = 'none';
                            this.$.readingTemplatePage.style.display = 'none';
                            this.$.clinicalInfoTab.style.display = 'none';
                            this.$.clinicalInfoPage.style.display = 'none';

                            this.$.btnExpand.active = true;
                        }

                        if (this.pin) {
                            this.$.btnPin.active = true;
                        }

                        // this.$.reportWindowPage.addEventListener('iron-select', e => {
                        //     if(e.detail.item.className === "reading-content iron-selected") {
                        //         this.$.hhImageReport.onLoadBody();
                        //
                        //         if(g_objId !== undefined) {
                        //             this.$.hhThumbnail.tabStartBody();
                        //         }
                        //     }
                        // });

                        this.$.hhThumbnail.addEventListener('toastEvent', function (e) {
                            _this.dispatchEvent(new CustomEvent('toastEvent', e));
                        });

                        this.$.hhThumbnail.addEventListener('setSelectedSeriesInfoEvent', function (e) {
                            _this.dispatchEvent(new CustomEvent('setSelectedSeriesInfoEvent', e));
                        });

                        this.$.hhClinicalInfo.addEventListener("clinicalInfoSaveEvent", e => {
                            let ccInfo = e.detail;
                            this.getClinicalInfo(ccInfo);
                        });

                        // this.$.report.addEventListener('printOpenEvent', function () {
                        //     _this.$.hhImageReport.getImageReport();
                        // });
                        //
                        // this.$.report.addEventListener('saveOpinionEvent', function () {
                        //     _this.$.hhImageReport.getStructImage();
                        // });
                        //
                        // this.$.report.addEventListener('approveOpinionEvnet', function () {
                        //     _this.$.hhImageReport.getStructImage();
                        // });
                        //
                        // this.$.hhImageReport.addEventListener('setImageReportEvent', function (e) {
                        //     _this.$.report.setImageReport(e.detail); // print에 뿌릴 imageReport
                        // });
                        //
                        // this.$.hhImageReport.addEventListener('setStructImageEvent', function (e) {
                        //     _this.$.report.setStructImage(e.detail); // db에 저장될 imageReport
                        // });
                    }

                    static get properties() {
                        return {
                            selectedTop: {
                                type: String,
                                value: 0
                            },
                            selectedBottomNew: {
                                type: String,
                                value: 0
                            },
                            selectedBottomOld: {
                                type: String,
                                value: 0
                            },
                            patientInfo: {
                                type: String,
                                value: "123456, 홍길동, M/30"
                            },
                            expand: {
                                type: Boolean,
                                value: false
                            },
                            pin: {
                                type: Boolean,
                                value: false
                            }
                        }
                    }

                    _onIronResize() {
                        parentWidth = this.parentNode.offsetWidth;
                    }

                    _pin() {

                    }

                    _expand(e) {
                        if(!this.$.btnPin.active) {
                            let selectedTop = this.selectedTop;
                            this.selectedTop = null;

                            let leftDiv = this.parentNode.querySelector('#worklistLeftDiv');
                            let rightDiv = this;

                            let expandRightDiv = [
                                {width: rightDiv.offsetWidth + 'px'},
                                {width: '1000px'}
                            ];

                            let contractLeftDiv = [
                                {width: (parentWidth - rightDiv.offsetWidth) + 'px'},
                                {width: (parentWidth - 1000) + 'px'}
                            ];

                            let contractRightDiv = [
                                {width: rightDiv.offsetWidth + 'px'},
                                {width: '470px'}
                            ];

                            let expandLeftDiv = [
                                {width: (parentWidth - rightDiv.offsetWidth) + 'px'},
                                {width: (parentWidth - 470) + 'px'}
                            ];

                            let duration = 500;

                            if (e.target.active) {
                                let animation = rightDiv.animate(expandRightDiv, {
                                    duration: duration,
                                    fill: 'forwards'
                                });

                                animation.onfinish = () => {
                                    this.$.div2.style.display = 'block';
                                    this.$.div3.style.display = 'block';
                                    this.$.div4.style.display = 'block';
                                    this.$.div1.style.width = '380px';
                                    this.$.div5.style.width = '590px';

                                    this.$.readingTemplateTab.style.display = 'none';
                                    this.$.readingTemplatePage.style.display = 'none';
                                    this.$.clinicalInfoTab.style.display = 'none';
                                    this.$.clinicalInfoPage.style.display = 'none';

                                    if (selectedTop == 2 || selectedTop == 3) {
                                        this.selectedTop = 0;
                                    } else {
                                        this.selectedTop = selectedTop;
                                    }
                                };

                                leftDiv.animate(contractLeftDiv, {
                                    duration: duration,
                                    fill: 'forwards'
                                });

                            } else {
                                this.$.readingTemplateTab.style.display = 'block';
                                this.$.readingTemplatePage.style.display = 'block';
                                this.$.clinicalInfoTab.style.display = 'block';
                                this.$.clinicalInfoPage.style.display = 'block';

                                this.$.div2.style.display = 'none';
                                this.$.div3.style.display = 'none';
                                this.$.div4.style.display = 'none';
                                this.$.div1.style.width = 'calc(100% - 20px)';
                                this.$.div5.style.width = 'calc(100% - 20px)';

                                let animation = rightDiv.animate(contractRightDiv, {
                                    duration: duration,
                                    fill: 'forwards'
                                });

                                animation.onfinish = () => {
                                    this.selectedTop = selectedTop;
                                };

                                leftDiv.animate(expandLeftDiv, {
                                    duration: duration,
                                    fill: 'forwards'
                                });
                            }
                        }
                    }

                    getWorkListNewId(id) {
                        g_objId = id;

                        getExamInfo(id).then( resultThumbnail => {
                            this.$.hhThumbnail.setExambyId(id, resultThumbnail);
                        });

                        // getStructImageById(id).then( structImage => {
                        //     _this.$.hhImageReport.setStructImage(structImage);
                        // } )
                    }

                    clearThumbnail() {
                        this.$.hhThumbnail.clearThumbnail();
                    }

                    setClinicalInfo(ccInfo) {
                        this.$.hhClinicalInfo.setClinicalInfo(ccInfo);
                        this.$.hhClinicalInfoExpend.setClinicalInfo(ccInfo);
                    }

                    setAllOldReportList(selectedRow){
                        getOldFilmWorklist(selectedRow).then((result) => {
                            let oldfilmList = new Array();
                            if(result.length > 0){
                                let cntAll = 0;
                                for (let i = 0; i < result.length; i++) {
                                    let oldfilm = new Object();
                                    let title = result[i].modality + " " + result[i].bodypart + " " + result[i].studyDtime;
                                    let report = "STUDY DESCRIPTION" + "\n" + result[i].studyDescription + "\n\n" + "FINDING" + "\n" + result[i].finding + "\n\n" + "CONCLUSION" + "\n" + result[i].conclusion + "\n\n" + "RECOMMENDATION" + "\n" + result[i].recommendation;
                                    oldfilm.title = title;
                                    oldfilm.report = report;
                                    oldfilm.finding = result[i].finding;
                                    oldfilm.conclusion = result[i].conclusion;
                                    oldfilm.recommendation = result[i].recommendation;
                                    oldfilmList[i] = oldfilm;
                                    cntAll++;
                                    if(cntAll == result.length){;
                                        this.$.allHhReportOldFilm.oldfilm = oldfilmList;
                                        this.$.allHhReportOldFilm.setOldFilmList(oldfilmList);
                                    };
                                }
                            }else{
                                let oldfilm = new Object();
                                let oldfilmList = new Array();
                                oldfilm.title = "";
                                oldfilm.report = "";
                                oldfilm.finding = "";
                                oldfilm.conclusion = "";
                                oldfilm.recommendation = "";
                                this.$.allHhReportOldFilm.oldfilm = oldfilmList;
                            }
                        }, (err) => {
                            console.log(err);
                        });
                    }

                    getClinicalInfo(ccInfo) {
                        if((ccInfo === undefined || ccInfo === "")&& g_objId === undefined) {
                            g_message.msg = "Please Checked ClinicalInfo";
                            g_message.isErr = true;
                            openToast(g_message);
                        }
                        else {
                            setClinicalInfoById(g_objId, ccInfo);
                        }
                    }

                    clearClinicalInfo() {
                        this.$.hhClinicalInfo.clearClinicalInfo();
                        this.$.hhClinicalInfoExpend.clearClinicalInfo();
                    }

                    setReadingTemplate(selectedNewFilm){
                        console.log(selectedNewFilm);
                    }

                    saveReadingTemplate(){

                    }

                    updateReadingTemplate(){

                    }

                    setOpinion(opinion) {
                        this.$.report.findings = opinion.findings;
                        this.$.report.conclusion = opinion.conclusion;
                        this.$.report.recommendation = opinion.recommendation;
                        this.$.report.recommendation = opinion.recommendation;
                        this.$.report.approver = opinion.radiologist;
                    }
                }

                window.customElements.define(HhReportWindow.is, HhReportWindow);
            }
        )();
    </script>
</dom-module>
